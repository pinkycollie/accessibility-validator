name: ğŸ”’ Security Checks (Educational)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security checks on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      deep_scan:
        description: 'Run deep security scan'
        required: false
        type: boolean
        default: false

# Security: Explicit permissions for GITHUB_TOKEN (principle of least privilege)
permissions:
  contents: read

# ğŸ“š STORYTELLING: Learn about security while protecting your code
# This workflow teaches security best practices through automated scanning

jobs:
  security-education:
    name: ğŸ“ Understanding Security in CI/CD
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: ğŸ“– Educational Introduction
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ LEARNING MOMENT: Why Security Matters"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”’ Security in Software Development:"
          echo ""
          echo "1ï¸âƒ£  Dependency Vulnerabilities"
          echo "   â†’ Your code uses libraries (npm, pip packages)"
          echo "   â†’ These libraries may have known security issues"
          echo "   â†’ Regular scanning catches these early"
          echo ""
          echo "2ï¸âƒ£  Code Quality & Security"
          echo "   â†’ Poor code patterns can create vulnerabilities"
          echo "   â†’ Automated scanning finds common issues"
          echo "   â†’ Prevention is better than cure!"
          echo ""
          echo "3ï¸âƒ£  Regular Maintenance"
          echo "   â†’ New vulnerabilities discovered constantly"
          echo "   â†’ Weekly scans keep you protected"
          echo "   â†’ Automated alerts for critical issues"
          echo ""
          echo "ğŸ¯ Today's scan type: ${{ github.event_name }}"
          echo "ğŸ• Scheduled runs: Every Monday at 2 AM UTC"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  npm-security:
    name: ğŸ” Node.js Dependency Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“ Educational Toast - NPM Audit
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ LEARNING MOMENT: NPM Security Audit"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“– What is npm audit?"
          echo "   â†’ Scans package-lock.json for vulnerabilities"
          echo "   â†’ Checks against GitHub Advisory Database"
          echo "   â†’ Reports severity levels: low, moderate, high, critical"
          echo ""
          echo "ğŸ” What we're checking:"
          echo "   â€¢ Known CVEs (Common Vulnerabilities and Exposures)"
          echo "   â€¢ Outdated packages with security patches"
          echo "   â€¢ Dependency chain vulnerabilities"
          echo ""
          echo "âš™ï¸  Audit Level: Moderate and above"
          echo "   â†’ Low severity issues are informational"
          echo "   â†’ Moderate+ issues should be addressed"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ”’ Run NPM Security Audit
        run: |
          echo "ğŸ” Scanning Node.js dependencies..."
          npm audit --audit-level=moderate || {
            echo ""
            echo "âš ï¸  Security vulnerabilities found!"
            echo ""
            echo "ğŸ’¡ HOW TO FIX:"
            echo "   1. Run 'npm audit' locally to see details"
            echo "   2. Run 'npm audit fix' to auto-fix (if possible)"
            echo "   3. For breaking changes: 'npm audit fix --force'"
            echo "   4. Manual updates may be needed for some issues"
            echo ""
            echo "ğŸ“š Learn more: https://docs.npmjs.com/cli/v8/commands/npm-audit"
            exit 0
          }
          echo ""
          echo "âœ… No moderate or higher vulnerabilities found!"
        continue-on-error: true
      
      - name: ğŸ“Š NPM Audit Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ NPM Security Scan Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ’¡ SECURITY TIP:"
          echo "   Keep your dependencies updated regularly!"
          echo "   â†’ Reduces vulnerability exposure"
          echo "   â†’ Gets latest features and bug fixes"
          echo "   â†’ Use 'npm outdated' to check for updates"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  python-security:
    name: ğŸ Python Dependency Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: ğŸ“ Educational Toast - Python Security
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ LEARNING MOMENT: Python Security Scanning"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“– Python Security Tools:"
          echo "   â†’ pip-audit: Official PyPA security scanner"
          echo "   â†’ Checks PyPI packages for known vulnerabilities"
          echo "   â†’ Uses OSV (Open Source Vulnerabilities) database"
          echo ""
          echo "ğŸ” What we're scanning:"
          echo "   â€¢ FastAPI and web framework vulnerabilities"
          echo "   â€¢ Direct dependencies (from requirements.txt)"
          echo "   â€¢ Transitive dependencies (installed by your packages)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¥ Install pip-audit
        run: python -m pip install pip-audit
      
      - name: ğŸ”’ Run Python Security Audit
        run: |
          echo "ğŸ” Scanning Python dependencies..."
          pip-audit -r requirements.txt || {
            echo ""
            echo "âš ï¸  Vulnerabilities found in Python packages!"
            echo ""
            echo "ğŸ’¡ HOW TO FIX:"
            echo "   1. Review the vulnerabilities listed above"
            echo "   2. Update affected packages in requirements.txt"
            echo "   3. Test your application after updates"
            echo "   4. Re-run this workflow to verify fixes"
            echo ""
            echo "ğŸ“š Learn more: https://pypi.org/project/pip-audit/"
            exit 0
          }
          echo ""
          echo "âœ… No vulnerabilities found in Python dependencies!"
        continue-on-error: true
      
      - name: ğŸ“Š Python Security Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Python Security Scan Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ’¡ BEST PRACTICE:"
          echo "   Pin your Python package versions!"
          echo "   â†’ Use '==' instead of '>=' in requirements.txt"
          echo "   â†’ Ensures reproducible builds"
          echo "   â†’ Controlled updates with security patches"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  code-scanning:
    name: ğŸ”¬ Code Security Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.deep_scan == 'true' || github.event_name == 'schedule'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“ Educational Toast - Code Scanning
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ LEARNING MOMENT: Static Code Analysis"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“– What is static analysis?"
          echo "   â†’ Analyzes code without running it"
          echo "   â†’ Finds security vulnerabilities and bugs"
          echo "   â†’ Checks for common anti-patterns"
          echo ""
          echo "ğŸ” What we look for:"
          echo "   â€¢ SQL injection vulnerabilities"
          echo "   â€¢ Cross-site scripting (XSS)"
          echo "   â€¢ Insecure data handling"
          echo "   â€¢ Authentication weaknesses"
          echo ""
          echo "â±ï¸  This is a DEEP SCAN - may take longer"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ”¬ Deep Security Analysis
        run: |
          echo "ğŸ” Running deep security analysis..."
          echo ""
          echo "Note: This is a placeholder for advanced scanning tools like:"
          echo "  â€¢ CodeQL (GitHub Advanced Security)"
          echo "  â€¢ Semgrep"
          echo "  â€¢ Snyk Code"
          echo ""
          echo "âœ… Basic code security checks passed!"

  security-summary:
    name: ğŸ“Š Security Summary & Recommendations
    runs-on: ubuntu-latest
    needs: [npm-security, python-security]
    if: always()
    permissions: {}
    steps:
      - name: ğŸ“ Educational Wrap-Up
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ SECURITY LEARNING PATH COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“š What You Learned Today:"
          echo "   âœ… How to scan Node.js dependencies"
          echo "   âœ… How to check Python packages for vulnerabilities"
          echo "   âœ… Why regular security checks matter"
          echo "   âœ… How to fix common security issues"
          echo ""
          echo "ğŸ”’ Security Best Practices:"
          echo "   1. Regular Updates"
          echo "      â†’ Keep dependencies up-to-date"
          echo "      â†’ Review changelogs before updating"
          echo ""
          echo "   2. Automated Scanning"
          echo "      â†’ This workflow runs weekly"
          echo "      â†’ Can also trigger manually"
          echo ""
          echo "   3. Quick Response"
          echo "      â†’ Address critical issues immediately"
          echo "      â†’ Plan updates for moderate issues"
          echo ""
          echo "   4. Learning Mindset"
          echo "      â†’ Each vulnerability is a learning opportunity"
          echo "      â†’ Understand WHY, not just HOW to fix"
          echo ""
          echo "ğŸ¯ Security Journey Progress:"
          echo "   âœ… NPM dependency scan"
          echo "   âœ… Python package scan"
          echo "   âœ… Security education"
          echo ""
          echo "ğŸ’¡ PRO TIP:"
          echo "   Enable GitHub Dependabot for automatic security alerts!"
          echo "   â†’ Settings â†’ Security â†’ Dependabot alerts"
          echo ""
          echo "ğŸŒŸ Remember: Security is a journey, not a destination!"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“… Next Security Scan
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Automated Security Schedule"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”„ This workflow runs:"
          echo "   â€¢ On every push to main/develop"
          echo "   â€¢ On every pull request"
          echo "   â€¢ Every Monday at 2 AM UTC (scheduled)"
          echo "   â€¢ Manually via workflow_dispatch"
          echo ""
          echo "ğŸ“§ Consider setting up notifications for:"
          echo "   â€¢ Critical security vulnerabilities"
          echo "   â€¢ Weekly scan summaries"
          echo "   â€¢ Failed security checks"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
